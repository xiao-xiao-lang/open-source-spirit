name = "open-source-spirit"
main = "functions/_middleware.js"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

[vars]
# 环境变量
APP_NAME = "开源精神分号器"
APP_VERSION = "1.0.0"
ADMIN_USERNAME = "admin"
SESSION_SECRET = "change-this-to-a-random-secret-in-production"

# CORS设置
ALLOWED_ORIGINS = "*"

# API设置
API_RATE_LIMIT = "1000 per hour"

[[d1_databases]]
binding = "DB"  # 在代码中通过env.DB访问
database_name = "open-source-spirit"
database_id = "fba71129-bf89-4120-bded-c98f7147014b"  # 替换为您的D1数据库ID

# 如使用多个环境
[env.dev]
name = "open-source-spirit-dev"
compatibility_date = "2024-01-01"

[env.production]
name = "open-source-spirit-prod"
compatibility_date = "2024-01-01"

# 站点配置（用于Cloudflare Pages）
[site]
bucket = "./public"           # 前端文件目录
entry-point = "functions"     # 后端函数目录
exclude = ["node_modules/*", "*.sql"]  # 排除文件

# 构建配置
[build]
command = "npm run build"
output_dir = "public"

[build.upload]
format = "service-worker"

# 开发服务器配置
[dev]
port = 8787
local_protocol = "http"
ip = "localhost"

# 日志配置
[log_level]
DEFAULT = "info"
API = "warn"
DB = "error"

# 分析配置（可选）
[analytics_engine_datasets]
binding = "ANALYTICS"
dataset = "open_source_analytics"

# 路由配置（如果使用自定义域名）
[[routes]]
pattern = "open-source-spirit.your-domain.com/*"
zone_name = "your-domain.com"

# KV命名空间（用于会话存储，可选）
[[kv_namespaces]]
binding = "SESSIONS"
id = "YOUR_KV_NAMESPACE_ID_HERE"  # 如果需要会话存储
preview_id = "YOUR_PREVIEW_KV_ID_HERE"

# R2存储桶（用于文件存储，可选）
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "open-source-files"
preview_bucket_name = "open-source-files-preview"

# 队列（用于异步任务，可选）
[[queues.producers]]
binding = "TASK_QUEUE"
queue = "open-source-tasks"

# Durable Objects（可选）
[[durable_objects.bindings]]
name = "COUNTER"
class_name = "Counter"

[migrations]
tag = "v1"
new_classes = ["Counter"]

# 缓存配置
[cache]
# 默认缓存行为
default_max_age = 3600

# 页面规则（用于Cloudflare Pages）
[[pages.rules]]
pattern = "/api/*"
workers = true

[[pages.rules]]
pattern = "/*.js"
headers = { "Cache-Control" = "public, max-age=31536000, immutable" }

[[pages.rules]]
pattern = "/*.css"
headers = { "Cache-Control" = "public, max-age=31536000, immutable" }

[[pages.rules]]
pattern = "/assets/*"
headers = { "Cache-Control" = "public, max-age=31536000, immutable" }

# 安全头（自动添加）
[[headers]]
for = "/*"
[headers.values]
"X-Frame-Options" = "DENY"
"X-Content-Type-Options" = "nosniff"
"X-XSS-Protection" = "1; mode=block"
"Referrer-Policy" = "strict-origin-when-cross-origin"
"Permissions-Policy" = "camera=(), microphone=(), geolocation=()"
"Content-Security-Policy" = "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self'"

# 部署钩子（可选）
[triggers]
crons = ["0 0 * * *"]  # 每天午夜执行维护任务

# 监控配置
[observability]
enabled = true
[observability.traces]
sampling_rate = 0.1
[observability.metrics]
enabled = true

# 价格层
[usage_model]
bundled = "free"  # 免费层